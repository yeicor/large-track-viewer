<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <title>Large Track Viewer</title>
        <link data-trunk rel="rust" data-wasm-opt="z" data-target-name="large-track-viewer" />
        <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;700&display=swap" rel="stylesheet" />
        <style>
            html {
                /* Remove touch delay: */
                touch-action: manipulation;
            }

            body {
                background: linear-gradient(135deg, #8e9eab 0%, #eef2f3 100%);
                font-family: "Ubuntu", Helvetica, Arial, sans-serif;
                transition: background 0.5s;
            }

            @media (prefers-color-scheme: dark) {
                body {
                    background: linear-gradient(135deg, #232526 0%, #414345 100%);
                }
            }

            html,
            body {
                overflow: hidden;
                margin: 0 !important;
                padding: 0 !important;
                height: 100%;
                width: 100%;
            }

            canvas {
                margin-right: auto;
                margin-left: auto;
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1;
                background: transparent;
                transition: box-shadow 0.3s;
                box-shadow: 0 0 32px 0 rgba(0, 0, 0, 0.1);
            }

            .centered {
                margin-right: auto;
                margin-left: auto;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #222;
                font-size: 24px;
                font-family: "Ubuntu", Helvetica, sans-serif;
                text-align: center;
                z-index: 10;
                background: rgba(255, 255, 255, 0.92);
                border-radius: 18px;
                box-shadow: 0 4px 32px 0 rgba(0, 0, 0, 0.1);
                padding: 36px 32px 32px 32px;
                min-width: 320px;
                max-width: 90vw;
                transition:
                    background 0.4s,
                    color 0.4s;
                animation: fadeIn 0.7s;
            }

            @media (prefers-color-scheme: dark) {
                .centered {
                    background: rgba(32, 32, 32, 0.92);
                    color: #f0f0f0;
                }
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, -60%);
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, -50%);
                }
            }

            .centered h1 {
                font-size: 2.2rem;
                font-weight: 700;
                margin: 0 0 12px 0;
                letter-spacing: 0.02em;
            }

            .centered p {
                font-size: 1.1rem;
                margin: 0 0 18px 0;
                color: #444;
            }

            @media (prefers-color-scheme: dark) {
                .centered p {
                    color: #ccc;
                }
            }

            .lds-dual-ring {
                display: inline-block;
                width: 48px;
                height: 48px;
                margin-bottom: 18px;
            }

            .lds-dual-ring:after {
                content: " ";
                display: block;
                width: 46px;
                height: 46px;
                margin: 1px;
                border-radius: 50%;
                border: 5px solid #4e8cff;
                border-color: #4e8cff transparent #4e8cff transparent;
                animation: lds-dual-ring 1.2s linear infinite;
            }

            @media (prefers-color-scheme: dark) {
                .lds-dual-ring:after {
                    border: 5px solid #90caf9;
                    border-color: #90caf9 transparent #90caf9 transparent;
                }
            }

            @keyframes lds-dual-ring {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .error-message {
                color: #ff4e4e;
                font-weight: 600;
                font-size: 1.15rem;
                margin-bottom: 12px;
                word-break: break-word;
            }

            .error-stack {
                font-size: 0.95rem;
                color: #fff;
                background: #222;
                padding: 10px 14px;
                border-radius: 6px;
                max-width: 80vw;
                overflow-x: auto;
                margin-bottom: 12px;
                text-align: left;
                font-family: "Ubuntu Mono", "Fira Mono", "Consolas", monospace;
            }

            .reload-btn {
                margin-top: 18px;
                font-size: 1.1rem;
                padding: 10px 28px;
                border: none;
                border-radius: 6px;
                background: linear-gradient(90deg, #4e8cff 0%, #1976d2 100%);
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 2px 8px 0 rgba(30, 80, 200, 0.1);
                transition:
                    background 0.2s,
                    box-shadow 0.2s;
            }
            .reload-btn:hover,
            .reload-btn:focus {
                background: linear-gradient(90deg, #1976d2 0%, #4e8cff 100%);
                box-shadow: 0 4px 16px 0 rgba(30, 80, 200, 0.18);
                outline: none;
            }

            .footer {
                position: fixed;
                left: 0;
                bottom: 0;
                width: 100vw;
                text-align: center;
                font-size: 0.98rem;
                color: #888;
                padding: 10px 0 8px 0;
                z-index: 20;
                pointer-events: none;
                user-select: none;
                letter-spacing: 0.01em;
            }
            @media (prefers-color-scheme: dark) {
                .footer {
                    color: #aaa;
                }
            }
        </style>
    </head>
    <body>
        <canvas id="the_canvas_id"></canvas>
        <div class="centered" id="center_text" aria-live="polite" aria-busy="true">
            <div class="lds-dual-ring"></div>
            <h1>Large Track Viewer</h1>
            <p>Loading applicationâ€¦</p>
        </div>
        <div class="footer" id="footer_text">
            &copy; <span id="footer_year"></span> Large Track Viewer &mdash; Made with &#10084; by
            <a href="https://github.com/Yeicor" target="_blank" rel="noopener" style="color: inherit; text-decoration: underline; pointer-events: auto">Yeicor</a>
        </div>
    </body>
    <script type="module">
        // Set footer year dynamically for polish
        (() => {
            const year = new Date().getFullYear();
            const footerYear = document.getElementById("footer_year");
            if (footerYear) footerYear.textContent = year;
        })();

        // Wait for TrunkApplicationStarted before doing anything else
        function onTrunkStarted(event) {
            const wasm = event.detail && event.detail.wasm;
            // Import the WASM JS glue code (Trunk will generate this)
            const WebHandle = window.wasmBindings.WebHandle;

            // Helper to log and show errors to the user
            function showError(message, callstack = null) {
                const centerText = document.getElementById("center_text");
                if (centerText) {
                    centerText.style.display = "flex";
                    centerText.setAttribute("aria-busy", "false");
                    centerText.innerHTML = `
                        <div class="lds-dual-ring" style="display:none"></div>
                        <h1 style="margin-bottom: 0.5em;">Large Track Viewer</h1>
                        <div class="error-message">Error: ${message}</div>
                        ${callstack ? `<pre class="error-stack">${callstack}</pre>` : ""}
                        <button class="reload-btn" id="reload_btn" tabindex="0" autofocus>Reload</button>
                    `;
                    const reloadBtn = document.getElementById("reload_btn");
                    if (reloadBtn) {
                        reloadBtn.onclick = () => location.reload();
                        reloadBtn.onkeydown = (e) => {
                            if (e.key === "Enter" || e.key === " ") {
                                e.preventDefault();
                                location.reload();
                            }
                        };
                    }
                }
                console.error("Large Track Viewer error:", message, callstack || "");
            }

            // Show a smooth fade-out for the loading overlay
            function hideLoadingOverlay() {
                const centerText = document.getElementById("center_text");
                if (centerText) {
                    centerText.setAttribute("aria-busy", "false");
                    centerText.style.transition = "opacity 0.5s";
                    centerText.style.opacity = "0";
                    setTimeout(() => {
                        centerText.style.display = "none";
                    }, 500);
                }
            }

            async function main() {
                try {
                    // Set up the Rust WebHandle
                    const handle = new WebHandle();

                    // Get the canvas element
                    const canvas = document.getElementById("the_canvas_id");
                    if (!canvas) {
                        showError("Canvas element not found.");
                        return;
                    }

                    // Monitor for panics and show details if they occur
                    function checkPanic() {
                        if (handle.has_panicked()) {
                            const msg = handle.panic_message() || "Unknown panic";
                            const stack = handle.panic_callstack() || "";
                            showError(msg, stack);
                        } else {
                            setTimeout(checkPanic, 1000);
                        }
                    }
                    setTimeout(checkPanic, 1000);

                    // Actually start the Rust app
                    await handle.start(canvas);

                    hideLoadingOverlay();
                } catch (e) {
                    let msg = e && e.message ? e.message : String(e);
                    let stack = e && e.stack ? e.stack : "";
                    showError(msg, stack);
                }
            }

            if (document.readyState === "loading") {
                window.addEventListener("DOMContentLoaded", main);
            } else {
                main();
            }
        }

        // Listen for TrunkApplicationStarted before accessing window or doing anything else
        window.addEventListener("TrunkApplicationStarted", onTrunkStarted, { once: true });
    </script>
</html>
